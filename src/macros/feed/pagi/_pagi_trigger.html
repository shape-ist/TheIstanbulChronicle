{% macro pagi_trigger() %}
<div id="pagi-trigger"></div>

<style>
    #pagi-trigger {
        position: relative;
        background: transparent;
        opacity: 0;
        height: 1px;
        width: 100%;
        top: 100%;
        bottom: 800px;
        pointer-events: none !important;
    }
</style>
<script src='https://cdn.socket.io/4.1.2/socket.io.min.js' crossorigin='anonymous'></script>
<script type="text/javascript" charset="utf-8">
    var pagiState = false

    function inArea(threshold = 100, current = $(window).scrollTop()) {
        return current + $(window).height() > $(document).height() - threshold
    }

    function canPagi() {
        return ($('#pagi-trigger').visible() && !pagiState && $('#article-list').height() > 1)
    }

    function appendArticle(article) {
        article.timestamp = unixTime(article.timestamp)
        cuid = generateUID()
        appended = $('#article-list-inner').append($(`<div class="article-list-item"><div id=${cuid}>`))
        $(`#${cuid}`).loadTemplate($("#article-item"), {...article});
    }

    var socket = io();
    var pagiStore = [{
        data: null,
        last_uid: null
    }]

    socket.on('message', function (msg) {
        pagiStore.push(msg)
        msg.data.forEach(function(i){
            console.log(i.title)
            appendArticle(i)
        })
        pagiState = false
    })

    function pagi() {
        pagiState = true
        if (pagiStore.at(-1).last_uid !== undefined) {
            socket.emit('pagiRequest', pagiStore.at(-1).last_uid);
        } else {
            clearInterval(pagiInterval);
        }
    }

    pagi()
    var pagiInterval = window.setInterval(function () {
        if (canPagi()) {
            pagi()
        }
    }, 500);
</script>
{% endmacro %}